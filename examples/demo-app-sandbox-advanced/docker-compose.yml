# Generated by sandbox plugin (Advanced mode)
# Configurable: Python + Node.js with PostgreSQL and Redis

services:
  app:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
      args:
        PYTHON_VERSION: "3.12"
        NODE_VERSION: "20"
    volumes:
      - .:/workspace:cached
    environment:
      # Database Configuration
      - DATABASE_URL=postgresql://sandbox_user:devpassword@postgres:5432/sandbox_dev
      - REDIS_URL=redis://redis:6379

      # Firewall Configuration (Advanced mode: user-configurable)
      # Options: "strict" (whitelist-only), "permissive" (audit mode), "disabled"
      - FIREWALL_MODE=${FIREWALL_MODE:-strict}

      # Development Environment
      - NODE_ENV=development
      - PYTHONUNBUFFERED=1

    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - demo-advanced-network
    # Restart policy for development
    restart: unless-stopped
    # Resource limits (Advanced tier)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-sandbox_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
      POSTGRES_DB: ${POSTGRES_DB:-sandbox_dev}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Optional: Mount custom init scripts
      # - ./db-init:/docker-entrypoint-initdb.d:ro
    ports:
      # Optional: Expose PostgreSQL for external tools
      # - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sandbox_user} -d ${POSTGRES_DB:-sandbox_dev}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - demo-advanced-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      # Optional: Expose Redis for external tools
      # - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - demo-advanced-network
    restart: unless-stopped

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local

networks:
  demo-advanced-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
