# Generated by windows-sandbox plugin (YOLO mode)
# Production-ready: Comprehensive configuration with full customization

version: '3.9'

services:
  # ==========================================================================
  # Application Container (Python + Node.js Development Environment)
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
      args:
        NODE_VERSION: "${NODE_VERSION:-20}"
        BUILD_DATE: "${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}"
        VCS_REF: "${VCS_REF:-$(git rev-parse --short HEAD)}"
      # Use BuildKit for optimal build performance
      cache_from:
        - type=registry,ref=myregistry/myimage:buildcache

    image: demo-app-sandbox-yolo:latest
    container_name: demo-app-yolo
    hostname: demo-app-yolo

    volumes:
      # Workspace volume with optimal caching
      - .:/workspace:cached
      # Named volumes for better performance
      - node_modules:/workspace/frontend/node_modules
      - python_cache:/home/node/.cache
      # Docker socket (for Docker-in-Docker scenarios)
      # - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      # Database Configuration
      - DATABASE_URL=${DATABASE_URL:-postgresql://${POSTGRES_USER:-sandbox_user}:${POSTGRES_PASSWORD:-devpassword}@postgres:5432/${POSTGRES_DB:-sandbox_dev}}
      - DATABASE_POOL_SIZE=${DATABASE_POOL_SIZE:-10}
      - DATABASE_MAX_OVERFLOW=${DATABASE_MAX_OVERFLOW:-20}

      # Redis Configuration
      - REDIS_URL=redis://redis:6379/${REDIS_DB:-0}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-50}

      # Firewall Configuration
      # Options: "strict" (whitelist-only), "permissive" (audit mode), "disabled" (no firewall)
      - FIREWALL_MODE=${FIREWALL_MODE:-strict}

      # Application Configuration
      - APP_ENV=${APP_ENV:-development}
      - DEBUG=${DEBUG:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Python Configuration
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/workspace

      # Node.js Configuration
      - NODE_ENV=${NODE_ENV:-development}
      - NPM_CONFIG_LOGLEVEL=${NPM_CONFIG_LOGLEVEL:-info}

      # Security Configuration
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5173,http://localhost:8000}

      # Monitoring & Observability
      - SENTRY_DSN=${SENTRY_DSN:-}
      - ENABLE_PROFILING=${ENABLE_PROFILING:-false}

      # Development Tools
      - PYTEST_ADDOPTS=--color=yes --verbose
      - COVERAGE_FILE=/workspace/.coverage

    cap_add:
      - NET_ADMIN  # Required for firewall/iptables
      - NET_RAW    # Required for raw socket operations
      # - SYS_PTRACE  # Uncomment for debugging with ptrace

    cap_drop:
      - ALL  # Drop all capabilities, then add only required ones

    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    networks:
      - demo-yolo-network

    restart: unless-stopped

    # Resource limits (YOLO mode: Production-ready)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

    # Health check for the application container
    healthcheck:
      test: ["CMD", "python", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # PostgreSQL Database (Production-Ready Configuration)
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: demo-postgres-yolo
    hostname: postgres

    environment:
      # Database credentials
      POSTGRES_USER: ${POSTGRES_USER:-sandbox_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
      POSTGRES_DB: ${POSTGRES_DB:-sandbox_dev}

      # PostgreSQL configuration
      POSTGRES_INITDB_ARGS: --encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8
      PGDATA: /var/lib/postgresql/data/pgdata

      # Performance tuning
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-256MB}
      POSTGRES_WORK_MEM: ${POSTGRES_WORK_MEM:-16MB}
      POSTGRES_MAINTENANCE_WORK_MEM: ${POSTGRES_MAINTENANCE_WORK_MEM:-128MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}

    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Optional: Mount initialization scripts
      - ./db-init:/docker-entrypoint-initdb.d:ro
      # Optional: Mount custom postgresql.conf
      # - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro

    ports:
      # Expose PostgreSQL for external tools (optional)
      - "${POSTGRES_PORT:-5432}:5432"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sandbox_user} -d ${POSTGRES_DB:-sandbox_dev}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - demo-yolo-network

    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Redis Cache (Production-Ready Configuration)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: demo-redis-yolo
    hostname: redis

    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory ${REDIS_MAX_MEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
      --loglevel ${REDIS_LOG_LEVEL:-notice}

    volumes:
      - redis-data:/data
      # Optional: Mount custom redis.conf
      # - ./redis.conf:/usr/local/etc/redis/redis.conf:ro

    ports:
      # Expose Redis for external tools (optional)
      - "${REDIS_PORT:-6379}:6379"

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - demo-yolo-network

    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Optional: pgAdmin (Database Administration Tool)
  # ==========================================================================
  # Uncomment to enable pgAdmin for database management
  # pgadmin:
  #   image: dpage/pgadmin4:latest
  #   container_name: demo-pgadmin-yolo
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
  #     PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
  #     PGADMIN_CONFIG_SERVER_MODE: 'False'
  #   volumes:
  #     - pgadmin-data:/var/lib/pgadmin
  #   ports:
  #     - "5050:80"
  #   networks:
  #     - demo-yolo-network
  #   depends_on:
  #     - postgres
  #   restart: unless-stopped

  # ==========================================================================
  # Optional: Redis Commander (Redis Administration Tool)
  # ==========================================================================
  # Uncomment to enable Redis Commander for cache management
  # redis-commander:
  #   image: rediscommander/redis-commander:latest
  #   container_name: demo-redis-commander-yolo
  #   environment:
  #     REDIS_HOSTS: local:redis:6379
  #   ports:
  #     - "8081:8081"
  #   networks:
  #     - demo-yolo-network
  #   depends_on:
  #     - redis
  #   restart: unless-stopped

# ==============================================================================
# Volumes (Named volumes for better performance and persistence)
# ==============================================================================
volumes:
  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-./.data}/postgres

  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-./.data}/redis

  node_modules:
    driver: local

  python_cache:
    driver: local

  # pgadmin-data:
  #   driver: local

# ==============================================================================
# Networks (Custom network configuration)
# ==============================================================================
networks:
  demo-yolo-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${NETWORK_SUBNET:-172.29.0.0/16}
          gateway: ${NETWORK_GATEWAY:-172.29.0.1}
    driver_opts:
      com.docker.network.bridge.name: br-demo-yolo
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.enable_icc: "true"
