# Repo-Keeper System: Comprehensive Gap Analysis and Improvement Roadmap

## Executive Summary

The repo-keeper validation system is functional (5/7 checks passing, 71% success rate) but has **57 identified gaps** across 4 priority levels. This issue tracks the roadmap for addressing critical gaps, improving robustness, and achieving cross-platform parity.

**Current State:**
- ‚úÖ 5 checks passing: Version sync, Inventory accuracy, Relationships, Schemas, Feature coverage
- ‚ùå 2 checks failing: Link integrity (archived/plans files), File permissions (non-critical)

**Key Decision:** Migrate to Node.js as single dependency (replacing jq + python) using `ajv-cli` for JSON Schema validation.

---

## P1: Critical Gaps (Fix Before Next Release)

### üö® 1. Orphan File Detection Not Implemented in Bash
**File:** `docs/repo-keeper/scripts/validate-inventory.sh:245, 335-336`
**Impact:** Linux/macOS users cannot detect files that exist but aren't in INVENTORY.json
**Effort:** 2-3 hours
**Status:** PowerShell version works, bash explicitly says "Not implemented"

- [ ] Port orphan detection logic from PowerShell to bash
- [ ] Test on Linux/macOS
- [ ] Update documentation

### üö® 2. JSON Schema Validation Not Actually Performed
**Files:** `validate-schemas.sh`, `validate-schemas.ps1`
**Impact:** Scripts only check JSON syntax, don't validate against actual schemas
**Effort:** 4-6 hours
**Solution:** Use `ajv-cli` (Node.js) for proper schema validation

- [ ] Install ajv-cli dependency check
- [ ] Replace manual field checks with `ajv validate`
- [ ] Test against all JSON schemas
- [ ] Update both bash and PowerShell versions

### üö® 3. Minimal Data-File Schema
**File:** `docs/repo-keeper/schemas/data-file.schema.json`
**Impact:** Schema only defines 2 optional properties, cannot validate structure
**Effort:** 4-6 hours

- [ ] Create `secrets.schema.json`
- [ ] Create `variables.schema.json`
- [ ] Create `mcp-servers.schema.json`
- [ ] Create `official-images.schema.json`
- [ ] Update validation scripts to use specific schemas

### üö® 4. Hardcoded Windows Paths in PowerShell Scripts
**Files:** `validate-inventory.ps1:10`, `check-links.ps1:10`, `check-version-sync.ps1:9`
**Current:** `$repoRoot = "D:\!wip\sandbox-maxxing"`
**Effort:** 1-2 hours ‚ö° **QUICK WIN**

- [ ] Replace with auto-detection: `$repoRoot = (Get-Item "$scriptPath\..\..\..").FullName`
- [ ] Add environment variable override support
- [ ] Test on Windows and WSL

---

## P2: High Priority (Next Sprint)

### 5. Unified Node.js Dependency
**Current:** Scripts use jq + python + curl
**Target:** Node.js only (`node -e` for parsing, `ajv-cli` for validation)
**Effort:** 4-5 hours

**Scripts to update:**
- [ ] `validate-inventory.sh:31-34` - Replace python3 with Node.js
- [ ] `validate-relationships.sh:31-38` - Replace jq with Node.js
- [ ] `validate-completeness.sh:31-34` - Replace jq with Node.js
- [ ] `validate-schemas.sh:31-36` - Replace jq with ajv-cli
- [ ] Create `scripts/json-helper.js` for common operations
- [ ] Add dependency check function to all scripts
- [ ] Keep curl for HTTP-only operations

**Benefits:**
- Single dependency instead of 3
- Cross-platform consistency
- Robust JSON Schema validation

### 6. Fix Additional Hardcoded Values
**Effort:** 2-3 hours

- [ ] `run-all-checks.sh:8` - Auto-detect `REPO_ROOT` instead of `/workspace`
- [ ] `run-all-checks.ps1:13` - Auto-detect `$repoRoot` instead of `/workspace`
- [ ] `validate-content.sh:118` - Make `head -50` limit configurable
- [ ] `validate-content.sh:150` - Make `head -20` external links configurable
- [ ] `check-version-sync.sh:135-136` - Read data files list from INVENTORY.json
- [ ] `INVENTORY.json:2` - Document relative schema path usage

### 7. Document Dependencies in README
**File:** `docs/repo-keeper/README.md`
**Effort:** 1 hour ‚ö° **QUICK WIN**

- [ ] Add Dependencies section (Node.js 18+, bash 4.0+, PowerShell 7.0+)
- [ ] Document auto-installed tools (ajv-cli, ajv-formats)
- [ ] Add installation instructions
- [ ] Document optional dependencies (curl)
- [ ] List current limitations

---

## P3: Medium Priority (Next Month)

### 8. Error Handling Gaps
**Effort:** 4-6 hours

- [ ] `run-all-checks.sh:96` - Check subshell exit codes explicitly
- [ ] `validate-inventory.sh:60-73` - Fix `((VAR++))` failing with set -e
- [ ] `check-links.sh:50-121` - Add `set -o pipefail`
- [ ] `validate-completeness.sh:55-58` - Add error logging before `|| true`
- [ ] All scripts - Add `trap cleanup EXIT` for SIGINT/SIGTERM
- [ ] `validate-schemas.sh:59,134` - Log suppressed errors to debug file
- [ ] `run-all-checks.ps1:84-104` - Add `-ErrorAction Stop` and full exception logging

### 9. Cross-Platform Parity
**Effort:** 6-8 hours

- [ ] Standardize repo root auto-detection (bash and PowerShell)
- [ ] Use `[IO.Path]::Combine()` in PowerShell for path separators
- [ ] Port orphan detection to bash (X3)
- [ ] Document curl vs Invoke-WebRequest differences
- [ ] Verify `find -print0` and `Get-ChildItem` produce same results
- [ ] Test regex equivalence between grep and PowerShell
- [ ] Standardize verbose flag interface
- [ ] Document CRLF handling in both versions

---

## P4: Low Priority (Future)

### 10. Missing Validation Checks
**Total Effort:** ~28 hours

- [ ] V2 - Duplicate entries detection (1h)
- [ ] V3 - Circular reference detection (2h)
- [ ] V4 - Strict semver format validation (1h)
- [ ] V5 - Future timestamp detection (0.5h)
- [ ] V6 - File permission verification (1h)
- [ ] V7 - UTF-8 BOM detection (1h)
- [ ] V8 - Anchor link validation (3h)
- [ ] V9 - Image reference checking (2h)
- [ ] V10 - Code block syntax validation (1h)
- [ ] V11 - YAML frontmatter validation (2h)
- [ ] V12 - Data file schema validation (4h)
- [ ] V13 - Template variable checking (2h)
- [ ] V14 - Dockerfile linting (2h)
- [ ] V15 - docker-compose validation (2h)

### 11. Testing & Documentation
**Total Effort:** ~30 hours

- [ ] T1 - Create test framework (8h)
- [ ] T2 - Add unit tests for validators (16h)
- [ ] T3 - Document all required tools (1h)
- [ ] T4 - Document exit codes (1h)
- [ ] T5 - Error recovery guide (2h)
- [ ] T6 - Explain JSON Schemas (2h)
- [ ] T7 - Fix README orphan detection claim (0.5h) ‚ö° **QUICK WIN**

---

## Quick Wins (Can Do Today)

1. ‚ö° **Fix hardcoded Windows paths** (#4) - 15 minutes
2. ‚ö° **Document dependencies** (#7) - 20 minutes
3. ‚ö° **Fix README orphan detection claim** (T7) - 10 minutes
4. ‚ö° **Add chmod +x to scripts** - 5 minutes

---

## Implementation Phases

### Phase 1: Critical Fixes (Week 1-2)
- Focus: P1 gaps #1-4
- Goal: 100% critical gap closure

### Phase 2: Dependencies & Config (Week 3-4)
- Focus: P2 gaps #5-7
- Goal: Single Node.js dependency, full documentation

### Phase 3: Robustness (Week 5-6)
- Focus: P3 gaps #8-9
- Goal: Production-grade error handling, cross-platform parity

### Phase 4: Completeness (Week 7-12)
- Focus: P4 gaps #10-11
- Goal: Comprehensive validation coverage, test suite

---

## Success Metrics

| Metric | Current | Target |
|--------|---------|--------|
| Critical gaps | 4 | 0 |
| External dependencies | 3 (jq, python, curl) | 1 (Node.js) |
| Scripts with dependency checks | 0/8 | 8/8 |
| Cross-platform parity | ~70% | 100% |
| Test coverage | 0% | 80% |
| Documented dependencies | 0 | All |
| Validation checks passing | 5/7 (71%) | 7/7 (100%) |

---

## References

- Full improvement plan: `docs/plans/2025-12-18-repo-keeper-improvements.md`
- Validation scripts: `docs/repo-keeper/scripts/`
- JSON Schemas: `docs/repo-keeper/schemas/`
- Inventory: `docs/repo-keeper/INVENTORY.json`

---

**Related Issues:** None yet
**Dependencies:** Node.js 18+ (for Phase 2)
**Breaking Changes:** None (all improvements are backward compatible)
