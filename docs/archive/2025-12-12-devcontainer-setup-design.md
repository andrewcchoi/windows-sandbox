# DevContainer Sandbox Setup - Design Document

**Date:** 2025-12-12
**Purpose:** Add devcontainer configuration for plugin development + showcase example
**Status:** ✅ IMPLEMENTED (Minimal Approach)

---

## Implementation Note (2025-12-12)

**Actual implementation deviated from original design - chose minimal approach:**

- ✅ Created minimal devcontainer (Python + Node.js, no services)
- ✅ Separated services into `examples/docker-compose.yml`
- ✅ Updated documentation to reflect minimal approach
- ✅ Created regeneration scripts for keeping devcontainer in sync

**Rationale:** The plugin repository itself doesn't need database/cache services.
The minimal approach keeps development fast and demonstrates smart project detection.

**Original design below for reference:**

---

## Overview

This design adds a devcontainer setup to the Claude Code Sandbox plugin repository, serving dual purposes:
1. **Development Environment** - Immediate setup for plugin contributors
2. **Showcase Example** - Demonstrates the plugin's capabilities through dogfooding

## Architecture & Approach

### Dual-Purpose Strategy

The devcontainer serves two audiences simultaneously:
- **Contributors**: Immediate development environment with all dependencies pre-configured
- **Users**: Complete working example demonstrating what the plugin creates

### Self-Dogfooding

We use the plugin's own Basic mode to generate the initial configuration:
- Proves the plugin works as advertised
- Provides authentic output users can reference
- Generated config committed as-is with minimal modifications
- Any customizations clearly documented

### Repository Structure

```
sandbox-maxxing-plugin/
├── .devcontainer/          # Generated by plugin's Basic mode
│   ├── devcontainer.json
│   ├── Dockerfile
│   └── init-firewall.sh
├── docker-compose.yml      # Services: PostgreSQL, Redis
├── examples/
│   ├── README.md           # Examples index and learning path
│   ├── basic-streamlit/    # Minimal Streamlit demo
│   │   ├── app.py
│   │   └── README.md
│   └── demo-app/           # Full-stack blogging platform
│       ├── backend/        # FastAPI (Python)
│       ├── frontend/       # React/Express (Node.js)
│       ├── tests/          # Full test suite
│       └── README.md
```

### Technology Stack

- **Languages**: Python + Node.js
- **Services**: PostgreSQL + Redis
- **Firewall Mode**: Permissive (for development convenience)
- **Generation Method**: Plugin's Basic mode (auto-detection)

---

## Example Applications

### Two-Tier Approach

**Basic Example** (`examples/basic-streamlit/`):
- Minimal Streamlit app (~50 lines)
- Visual proof-of-concept showing connectivity
- Green checkmarks for PostgreSQL and Redis connections
- Simple buttons to test database and cache
- No tests needed - visual validation
- Run: `streamlit run app.py`
- **User Journey**: Start here to verify setup in 30 seconds

**Full Example** (`examples/demo-app/`):
- Complete blogging platform
- Reference implementation showing production patterns
- FastAPI backend + React frontend
- Full PostgreSQL and Redis integration
- Comprehensive test coverage
- **User Journey**: Explore after basic example works

---

## Demo Blogging Platform (Full Example)

### Core Functionality

Simple CRUD blogging platform demonstrating real-world patterns:
- Create, read, update, delete blog posts
- Post fields: title, content, author, timestamps, view count
- View counter increments on each read
- Demonstrates PostgreSQL persistence + Redis caching

### PostgreSQL Usage

**Data Storage**:
- Posts table with proper indexing
- SQLAlchemy (async) ORM
- Alembic migrations for schema versioning
- Schema: id, title, content, author, created_at, updated_at, view_count

**Pattern Demonstration**:
- Modern async Python database patterns
- Database schema versioning
- Proper indexing strategies

### Redis Caching Strategy

**Caching Pattern**:
- Post content cached on first read
- Cache key: `post:{id}:content`
- TTL (time-to-live) for automatic expiration
- Cache invalidation on post updates

**Counter Pattern**:
- View counts stored as Redis counters
- Counter key: `post:{id}:views`
- Periodically synced back to PostgreSQL
- Demonstrates Redis as both cache and counter store

### Frontend (Node.js/React)

**Features**:
- List view of all posts
- Individual post view with incrementing counter
- Create/edit post form
- Real-time view counter updates

**Demonstrates**:
- API consumption patterns
- State management
- Real-time updates

---

## Testing Strategy

### Backend Tests (Python/pytest)

**Coverage**:
- Unit tests for database models
- Integration tests for API endpoints
- Redis caching logic tests
- Target: 80%+ meaningful coverage

**Testing Tools**:
- pytest-asyncio for async tests
- pytest fixtures for setup/teardown
- Demonstrates service connectivity using Docker hostnames

### Frontend Tests (Node.js/Jest + React Testing Library)

**Coverage**:
- Component tests (post list, detail, form)
- API integration tests using Mock Service Workers (MSW)
- Async handling, form validation, state updates
- Focus: critical user paths and component behavior

### End-to-End Tests (Optional)

**Stretch Goal**:
- Playwright E2E test
- Full flow: create → view → increment counter → edit → cache invalidates
- Demonstrates complete stack integration
- Not required for MVP

### Test Execution

**Test Script** (`test.sh`):
- Runs backend and frontend tests sequentially
- Executes via `docker compose exec` or within devcontainer
- Proves sandbox setup works for testing workflows

---

## Implementation Process

### Step 1: Generate Base Configuration

1. Run plugin's `/sandbox:setup --basic` in repository root
2. Auto-detects Python from existing template files
3. Generates `.devcontainer/`, `docker-compose.yml`, firewall scripts
4. Accept defaults, change firewall to permissive mode

### Step 2: Customize for Plugin Development

**VS Code Extensions** (add to `devcontainer.json`):
- Python extension
- Jest Runner
- Prettier
- ESLint

**Environment Variables**:
- `DEVELOPMENT_MODE=true`
- Database connection strings (service names)

**Docker Compose Modifications**:
- Expose PostgreSQL port (5432) for pgAdmin
- Expose Redis port (6379) for Redis Commander
- Enables external tool access during development

### Step 3: Create Example Applications

**Basic Streamlit** (`examples/basic-streamlit/`):
```
basic-streamlit/
├── app.py          # ~50 lines, connection tests
└── README.md       # Setup and purpose
```

**Full Demo App** (`examples/demo-app/`):
```
demo-app/
├── backend/
│   ├── app/
│   │   ├── models.py       # SQLAlchemy models
│   │   ├── api.py          # FastAPI routes
│   │   ├── cache.py        # Redis caching logic
│   │   └── database.py     # DB connection
│   ├── alembic/            # Database migrations
│   ├── tests/              # pytest tests
│   └── requirements.txt
├── frontend/
│   ├── src/
│   │   ├── components/     # React components
│   │   ├── api/            # API client
│   │   └── App.tsx
│   ├── tests/              # Jest tests
│   └── package.json
├── tests/
│   └── integration/        # E2E tests (optional)
└── README.md
```

### Step 4: Documentation

**Create `docs/DEVELOPMENT.md`**:
- Prerequisites (Docker, VS Code, Claude Code CLI)
- Quick Start (clone → open → reopen in container)
- Running Examples (both basic and full)
- Testing guide
- Troubleshooting

**Update Root `README.md`**:
- Add "Development Setup" section with devcontainer badge
- Add "Examples" section linking to both demos
- Include note: "This plugin uses itself for development"
- Show screenshots of examples

**Example Documentation**:
- `examples/README.md` - Learning path index
- `examples/basic-streamlit/README.md` - Minimal app guide
- `examples/demo-app/README.md` - Full architecture guide

**Update `CONTRIBUTING.md`**:
- Document devcontainer regeneration process
- Note to update when templates change
- Ensure example stays current with best practices

---

## Documentation & Developer Experience

### Getting Started Guide (`docs/DEVELOPMENT.md`)

**Contents**:
1. **Prerequisites**
   - Docker Desktop installed
   - VS Code with Dev Containers extension
   - Claude Code CLI (optional, for testing plugin)

2. **Quick Start**
   - Clone repository
   - Open in VS Code
   - Ctrl+Shift+P → "Dev Containers: Reopen in Container"
   - Wait 2 minutes
   - Done!

3. **Running Examples**
   - Basic: `streamlit run examples/basic-streamlit/app.py`
   - Full: Instructions for backend + frontend

4. **Testing**
   - Run all tests: `./test.sh`
   - Backend only: `pytest backend/tests`
   - Frontend only: `npm test` in frontend/

5. **Troubleshooting**
   - Common plugin development issues
   - Service connectivity problems
   - Port conflicts

### Example Documentation

**`examples/README.md`** (Index):
```markdown
# Examples

## Learning Path

1. **Start Here**: `basic-streamlit/` - Verify setup works (30 seconds)
2. **Full Demo**: `demo-app/` - See real-world patterns

## Basic Streamlit Demo
Minimal app showing PostgreSQL + Redis connectivity.

## Full Blogging Platform
Production-ready patterns: API, caching, testing.
```

**`examples/basic-streamlit/README.md`**:
- What it demonstrates
- How to run
- What success looks like
- Next steps (try full demo)

**`examples/demo-app/README.md`**:
- Architecture overview
- Database schema
- API endpoints
- Caching strategy
- How to extend
- Testing guide

### Root README Updates

**New Sections**:

1. **Development Setup** (near top):
```markdown
## Development Setup

[![Open in Dev Containers](https://img.shields.io/static/v1?label=Dev%20Containers&message=Open&color=blue&logo=visualstudiocode)](https://vscode.dev/redirect?url=vscode://ms-vscode-remote.remote-containers/cloneInVolume?url=https://github.com/andrewcchoi/sandbox-maxxing)

This plugin uses itself for development! Open in VS Code and reopen in the devcontainer for immediate setup.

See [DEVELOPMENT.md](docs/DEVELOPMENT.md) for details.
```

2. **Examples** (after Features):
```markdown
## Examples

- **Basic Streamlit Demo**: Quick connectivity test
- **Full Blogging Platform**: Production patterns with FastAPI + React

[Explore Examples →](examples/)
```

### Maintenance Considerations

**Regeneration Process**:
- Periodically regenerate devcontainer using latest plugin version
- Document in `CONTRIBUTING.md`
- When plugin templates change, regenerate and update
- Ensures example always reflects current best practices

**Version Tracking**:
- Add comment in `devcontainer.json`: `// Generated with plugin v1.0.0`
- Update when regenerating
- Helps identify when config is stale

---

## Success Criteria

### For Contributors

- ✅ Clone → open in container → productive in under 3 minutes
- ✅ All services (PostgreSQL, Redis) immediately available
- ✅ Tests run successfully without configuration
- ✅ Examples demonstrate development workflow

### For Users

- ✅ Clear demonstration of plugin capabilities
- ✅ Basic example proves setup works quickly
- ✅ Full example shows production-ready patterns
- ✅ Documentation explains learning path

### For Plugin Quality

- ✅ Dogfooding validates plugin works
- ✅ Minimal customization proves templates are solid
- ✅ Examples serve as regression tests
- ✅ Contributor onboarding time reduced significantly

---

## Future Enhancements (Out of Scope)

- Additional example languages (Go, Rust)
- GitHub Actions integration example
- Plugin testing framework using the devcontainer
- Video walkthrough of examples
- Interactive tutorial mode in Streamlit app

---

## Appendix: File Checklist

Files to create:

**DevContainer**:
- [ ] `.devcontainer/devcontainer.json` (generated + customized)
- [ ] `.devcontainer/Dockerfile` (generated)
- [ ] `.devcontainer/init-firewall.sh` (generated)
- [ ] `docker-compose.yml` (generated + ports exposed)

**Examples**:
- [ ] `examples/README.md`
- [ ] `examples/basic-streamlit/app.py`
- [ ] `examples/basic-streamlit/README.md`
- [ ] `examples/demo-app/backend/` (complete FastAPI app)
- [ ] `examples/demo-app/frontend/` (complete React app)
- [ ] `examples/demo-app/tests/` (full test suite)
- [ ] `examples/demo-app/README.md`

**Documentation**:
- [ ] `docs/DEVELOPMENT.md`
- [ ] Update root `README.md`
- [ ] Update `CONTRIBUTING.md`

**Testing**:
- [ ] `test.sh` (root level test runner)
- [ ] Backend tests
- [ ] Frontend tests
