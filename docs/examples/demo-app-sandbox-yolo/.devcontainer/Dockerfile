# Generated by sandboxxer plugin (Custom Configuration)
# Technology-optimized: Python 3.12 + Node.js 20 with comprehensive tooling
# Multi-stage build for optimal image size and security

# ============================================================================
# Stage 0: Get Node.js from official image (Issue #29)
# ============================================================================
FROM node:20-slim AS node-source

# ============================================================================
# Stage 1: Base Python Image with System Dependencies
# ============================================================================
FROM python:3.12-slim-bookworm AS python-base

# Configure Python behavior
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies (optimized layer)
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build tools (for native extensions)
    build-essential \
    gcc \
    g++ \
    make \
    # Version control
    git \
    git-lfs \
    # Network utilities
    curl \
    wget \
    dnsutils \
    netcat-openbsd \
    # Firewall tools
    iptables \
    ipset \
    # SSL certificates
    ca-certificates \
    gnupg \
    # Process and system tools
    procps \
    htop \
    # Text editors
    vim \
    nano \
    # Additional utilities
    less \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Stage 2: Add Node.js
# ============================================================================
FROM python-base AS nodejs-added

ARG NODE_VERSION=20
ENV NODE_VERSION=${NODE_VERSION}

# Copy Node.js from official image (Issue #29 - avoids NodeSource SSL issues)
COPY --from=node-source /usr/local/bin/node /usr/local/bin/
COPY --from=node-source /usr/local/lib/node_modules /usr/local/lib/node_modules
RUN ln -s /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm && \
    ln -s /usr/local/lib/node_modules/npm/bin/npx-cli.js /usr/local/bin/npx

# Verify installations
RUN node --version && npm --version && python --version

# ============================================================================
# Stage 3: Python Development Tools
# ============================================================================
FROM nodejs-added AS python-tools

# Install comprehensive Python development tools
RUN uv add --no-cache-dir \
    # Code formatting
    black \
    isort \
    # Linting
    flake8 \
    pylint \
    ruff \
    # Type checking
    mypy \
    # Testing
    pytest \
    pytest-cov \
    pytest-asyncio \
    pytest-mock \
    # Debugging
    ipdb \
    ipython \
    # Documentation
    sphinx \
    # Performance profiling
    memory-profiler \
    line-profiler \
    # Security scanning
    bandit \
    safety

# ============================================================================
# Stage 4: Node.js Development Tools
# ============================================================================
FROM python-tools AS nodejs-tools

# Install global npm packages
RUN npm install -g \
    # Package management
    npm@latest \
    yarn \
    pnpm \
    # Build tools
    vite \
    # Linting & formatting
    eslint \
    prettier \
    # Testing
    jest \
    # Debugging
    nodemon \
    # Documentation
    jsdoc

# ============================================================================
# Stage 5: User Setup and Security
# ============================================================================
FROM nodejs-tools AS user-setup

# Create non-root user with comprehensive sudo access
RUN groupadd --gid 1000 node \
    && useradd --uid 1000 --gid node --shell /bin/bash --create-home node \
    && echo "node ALL=(ALL) NOPASSWD: /usr/sbin/iptables, /usr/sbin/ipset, /usr/sbin/ip6tables" >> /etc/sudoers \
    && mkdir -p /home/node/.local/bin \
    && chown -R node:node /home/node

# Copy firewall initialization script
COPY --chown=root:root .devcontainer/init-firewall.sh /usr/local/bin/init-firewall.sh
RUN chmod +x /usr/local/bin/init-firewall.sh

# ============================================================================
# Stage 6: Environment Configuration
# ============================================================================
FROM user-setup AS environment-config

# Switch to non-root user
USER node
WORKDIR /workspace

# Configure PATH
ENV PATH="/home/node/.local/bin:$PATH"

# Configure Python environment
ENV PYTHONPATH="/workspace:$PYTHONPATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Configure Node.js environment
ENV NODE_ENV=development \
    NPM_CONFIG_PREFIX=/home/node/.npm-global

# Add npm global bin to PATH
ENV PATH="$NPM_CONFIG_PREFIX/bin:$PATH"

# Configure shell prompt (enhanced for Custom Configuration)
RUN echo 'export PS1="\[\033[01;36m\][YOLO]\[\033[00m\] \[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /home/node/.bashrc \
    && echo 'alias ll="ls -alF"' >> /home/node/.bashrc \
    && echo 'alias la="ls -A"' >> /home/node/.bashrc \
    && echo 'alias l="ls -CF"' >> /home/node/.bashrc \
    && echo 'alias pytest="python -m pytest"' >> /home/node/.bashrc \
    && echo 'alias black="python -m black"' >> /home/node/.bashrc

# ============================================================================
# Stage 7: Final Image (Production-Ready Development Environment)
# ============================================================================
FROM environment-config AS final

# Add labels for documentation
LABEL maintainer="Claude Code Sandbox Plugin" \
      description="Custom Configuration DevContainer - Full-Stack Python + Node.js" \
      python.version="3.12" \
      node.version="20" \
      mode="yolo" \
      security.firewall="configurable"

# Health check for container
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD python --version && node --version || exit 1

# Default command (can be overridden)
CMD ["/bin/bash"]

# Image metadata
ARG BUILD_DATE
ARG VCS_REF
LABEL org.opencontainers.image.created=$BUILD_DATE \
      org.opencontainers.image.revision=$VCS_REF \
      org.opencontainers.image.title="Claude Code Sandbox (Custom Configuration)" \
      org.opencontainers.image.description="Production-ready development environment with Python 3.12 and Node.js 20"
