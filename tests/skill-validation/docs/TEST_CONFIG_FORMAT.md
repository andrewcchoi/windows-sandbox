# Test Configuration Format

This document describes the YAML configuration format used for automated skill testing.

## Overview

Test configuration files define automated responses to skill prompts, enabling headless testing of interactive skills. Each skill mode (basic, intermediate, advanced, yolo) has its own `test-config.yml` file.

## File Location

Test configs are located in example directories:
```
/workspace/examples/demo-app-sandbox-{mode}/test-config.yml
```

## Configuration Structure

### Complete Example

```yaml
metadata:
  mode: basic
  description: "Basic mode with Python backend, minimal setup"
  expected_files:
    - .devcontainer/devcontainer.json
    - .devcontainer/Dockerfile
    - docker-compose.yml
    - .devcontainer/init-firewall.sh
    - .devcontainer/setup-claude-credentials.sh

responses:
  - prompt_pattern: "project.*name|what.*call"
    response: "demo-app"

  - prompt_pattern: "language|stack"
    response: "python"

  - prompt_pattern: "services|database"
    response: "none"

  - prompt_pattern: "confirm|proceed"
    response: "yes"
```

## Sections

### metadata (optional)

Provides context about the test configuration:

- `mode`: The skill mode being tested (basic, intermediate, advanced, yolo)
- `description`: Human-readable description of what this mode does
- `expected_files`: List of files that should be generated by the skill

### responses (required)

Array of prompt-response pairs that define how to respond to skill questions.

Each response entry contains:

- `prompt_pattern`: Regular expression pattern to match skill prompts (case-insensitive)
- `response`: Text to send when pattern matches

## Pattern Matching

### Pattern Rules

1. **Case-insensitive**: Patterns are converted to lowercase before matching
2. **Regex syntax**: Use standard regex patterns (e.g., `.*` for wildcards, `|` for OR)
3. **Partial match**: Pattern can match anywhere in the prompt text
4. **Order matters**: Responses are tried in sequence by index first

### Pattern Examples

```yaml
# Simple keyword match
- prompt_pattern: "name"
  response: "demo-app"

# Multiple alternatives with OR
- prompt_pattern: "language|stack|framework"
  response: "python"

# Wildcard matching
- prompt_pattern: "project.*name"
  response: "my-project"

# Common prompt patterns
- prompt_pattern: "confirm|proceed|continue|ok"
  response: "yes"

# Negation or skip patterns
- prompt_pattern: "services|database|additional"
  response: "none"
```

## Response Matching Strategy

The response feeder uses a two-phase matching strategy:

1. **Ordered matching**: Try to match by response index (position in array)
2. **Fallback matching**: If ordered match fails, try matching any pattern

This provides resilience to question order changes while maintaining predictability.

## Validation Rules

The test harness validates configs before use:

1. **File exists**: Config file must be present
2. **Valid YAML**: Must parse as valid YAML
3. **Required sections**: Must have `responses:` section
4. **Response count**: Must have 1-20 response entries (not 0, not excessive)
5. **Balanced pairs**: Number of `prompt_pattern` entries must equal number of `response` entries

## Best Practices

### 1. Keep Patterns Broad But Specific

```yaml
# Good: Matches variations
- prompt_pattern: "project.*name|what.*call"
  response: "demo-app"

# Too narrow: May miss variations
- prompt_pattern: "Enter project name:"
  response: "demo-app"
```

### 2. Order by Question Sequence

List responses in the expected order the skill asks questions:

```yaml
responses:
  - prompt_pattern: "name"        # Asked first
    response: "demo-app"
  - prompt_pattern: "language"    # Asked second
    response: "python"
  - prompt_pattern: "confirm"     # Asked last
    response: "yes"
```

### 3. Use Generic Patterns for Common Prompts

```yaml
# Reusable confirmation pattern
- prompt_pattern: "confirm|proceed|continue|ready|ok"
  response: "yes"

# Reusable skip pattern
- prompt_pattern: "skip|none|additional|optional"
  response: "none"
```

### 4. Document Intent with Comments

```yaml
responses:
  # Project identification
  - prompt_pattern: "project.*name"
    response: "demo-app"

  # Primary language/framework
  - prompt_pattern: "language|stack"
    response: "python"

  # Additional services (none for basic mode)
  - prompt_pattern: "services|database"
    response: "none"
```

### 5. Test Your Patterns

Use the response feeder test mode to validate patterns:

```bash
cd /workspace/tests/skill-validation
TEST_MODE=true DEBUG=true ./lib/response-feeder.sh
```

## Common Patterns Reference

### Project Names
```yaml
- prompt_pattern: "project.*name|what.*call|app.*name"
  response: "demo-app"
```

### Languages/Stacks
```yaml
- prompt_pattern: "language|stack|framework|platform"
  response: "python"
```

### Database Selection
```yaml
- prompt_pattern: "database|db|storage"
  response: "postgres"
```

### Port Configuration
```yaml
- prompt_pattern: "port|expose"
  response: "3000,8080"
```

### Confirmation Prompts
```yaml
- prompt_pattern: "confirm|proceed|continue|ready|ok"
  response: "yes"
```

### Skip/None Options
```yaml
- prompt_pattern: "skip|none|additional|optional"
  response: "none"
```

## Troubleshooting

### Pattern Not Matching

If a pattern isn't matching:

1. Check the actual prompt text in logs (enable `DEBUG=true`)
2. Verify pattern uses lowercase (matching is case-insensitive)
3. Try broader patterns with wildcards: `.*name.*`
4. Add alternative patterns with OR: `name|title|identifier`

### Too Many Responses

If config validation fails with "too many responses":

- Maximum is 20 response entries
- Check for duplicate entries
- Combine similar patterns: `confirm|proceed|continue`

### Mismatched Counts

If validation reports mismatched pattern/response counts:

- Each `prompt_pattern` must have exactly one `response`
- Check YAML indentation (use 2 or 4 spaces consistently)
- Verify no extra or missing response entries

### YAML Syntax Errors

Common YAML issues:

```yaml
# Bad: Missing space after colon
- prompt_pattern:"name"

# Good: Space after colon
- prompt_pattern: "name"

# Bad: Inconsistent indentation
responses:
  - prompt_pattern: "name"
   response: "demo-app"

# Good: Consistent indentation
responses:
  - prompt_pattern: "name"
    response: "demo-app"
```

## See Also

- [README.md](../README.md) - Test system overview
- [response-feeder.sh](../lib/response-feeder.sh) - Implementation details
- [test-harness.sh](../test-harness.sh) - Test harness documentation
