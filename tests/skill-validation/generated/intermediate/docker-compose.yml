# ============================================================================
# INTERMEDIATE MODE - Docker Compose Template
# ============================================================================
# Common services with standard configuration for typical development needs
# Includes: postgres, redis, rabbitmq with healthchecks
# No resource limits - simpler than advanced mode
# ============================================================================

# =============================================================================
# APP SERVICE EXAMPLE (Issue #30 - Claude Credentials)
# =============================================================================
# When adding your app service, include the credentials mount:
#
#   app:
#     volumes:
#       - .:/workspace:cached
#       - ~/.claude:/tmp/host-claude:ro              # Host Claude config (read-only)
#       - ~/.config/claude-env:/tmp/host-env:ro      # Environment secrets (optional)
#       - ~/.config/gh:/tmp/host-gh:ro               # GitHub CLI config (optional)
#
# Then use .devcontainer/setup-claude-credentials.sh in postCreateCommand
# =============================================================================

services:
  postgres:
    image: postgres:16-bookworm
    container_name: demo-app-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-{{DB_NAME}}}
      POSTGRES_USER: ${POSTGRES_USER:-{{DB_USER}}}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-{{DB_USER}}} -d ${POSTGRES_DB:-{{DB_NAME}}}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - default

  redis:
    image: redis:7-alpine
    container_name: demo-app-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-devpassword}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - default

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: demo-app-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - default

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local

networks:
  default:
    name: {{NETWORK_NAME}}
    driver: bridge
